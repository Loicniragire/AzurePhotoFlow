trigger:
- main

pool:
  name: Default
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'AZ_PhotoFlow_connection'
  subscriptionId: 'ebe2acfb-f4a5-4f6b-8f30-252c571813f9'
  containerRegistryConnection: 'AzurePhotoFlowACR_connection'
  resourceGroupName: 'AzurePhotoFlow-RG'
  location: 'eastus'
  containerRegistry: 'azurephotoflowacr.azurecr.io'  # Ensure lowercase
  storageAccountName: 'photoflowtfstatedev'
  containerName: 'tfstate'
  cognitiveAccountName: 'azurephotoflowvision'
  tfStateFile: 'azurephotoflow.tfstate'
  backendAppServiceName: 'AzurePhotoFlowBE'
  frontendAppServiceName: 'AzurePhotoFlowFE'

resources:
  repositories:
    - repository: github_repo
      type: github
      name: Loicniragire/AzurePhotoFlow
      endpoint: 'github.com_Loicniragire' 

stages:
# Build Stage
- stage: Build
  displayName: Build Stage
  jobs:
  - job: BuildDockerImages
    displayName: Build Docker Images
    steps:
      # Checkout source code
      - checkout: github_repo

      # Build Backend Docker Image
      - task: Docker@2
        displayName: Build Backend Docker Image
        inputs:
          command: build
          dockerfile: backend/AzurePhotoFlow.Api/Dockerfile
          repository: $(containerRegistry)/azurephotoflow-backend
          argument: --no-cache
          tags: |
            $(Build.BuildId)

      # Build Frontend Docker Image
      - task: Docker@2
        displayName: Build Frontend Docker Image
        inputs:
          command: build
          dockerfile: frontend/Dockerfile
          arguments: --build-arg MODE=production
          repository: $(containerRegistry)/azurephotoflow-frontend
          argument: --no-cache
          tags: |
            $(Build.BuildId)

      # Verify Images
      - script: |
          docker images
        displayName: 'List Built Docker Images'

# Test Stage
- stage: Test
  displayName: Test Stage
  dependsOn: Build
  jobs:
  - job: RunTests
    displayName: Run Unit and Integration Tests
    steps:
      - checkout: self
      # Run backend tests
      - script: |
          cd $(Build.SourcesDirectory)/tests/backend/AzurePhotoFlow.Api.Tests
          dotnet restore
          dotnet test
        displayName: Run Backend Tests

      # Run frontend tests
      - script: |
          cd $(Build.SourcesDirectory)/tests/frontend
          npm install
          npm test
        displayName: Run Frontend Tests

# Deploy Infrastructure Stage
- stage: DeployInfrastructure
  displayName: Deploy Infrastructure
  dependsOn: Test
  jobs:
  - job: DeployTerraform
    displayName: Deploy Infrastructure with Terraform
    variables:
    - group: 'PhotoFlow'
    steps:
    # Authenticate and apply Terraform
    - script: |
        export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
        export ARM_CLIENT_SECRET=$(ARM_CLIENT_SECRET)
        export ARM_TENANT_ID=$(ARM_TENANT_ID)
        export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)

        cd $(Build.SourcesDirectory)/Infrastructure
        terraform init \
          -backend-config="storage_account_name=$(storageAccountName)" \
          -backend-config="container_name=$(containerName)" \
          -backend-config="key=$(tfStateFile)" \
          -backend-config="resource_group_name=$(resourceGroupName)" \
          -backend-config="subscription_id=$(ARM_SUBSCRIPTION_ID)"
        terraform apply -auto-approve
      displayName: Authenticate and Apply Terraform

# Deploy Applications Stage
- stage: DeployApplications
  displayName: Deploy Applications
  dependsOn: DeployInfrastructure
  variables:
    System.Debug: true
    docker_host: 'unix:///Users/loicniragire/.docker/run/docker.sock'
  jobs:
  - job: PushDockerImages
    displayName: Push Docker Images to ACR
    variables:
      - group: 'PhotoFlow'
    steps:
      # Login to Azure Container Registry
      - task: Docker@2
        displayName: Login to ACR
        inputs:
          command: login
          containerRegistry: $(containerRegistryConnection)
      - script: |
          echo "Using Container Registry: $(containerRegistryConnection)"
        displayName: 'Verify Container Registry Variable'

      - script: |
          export DOCKER_CONFIG=$HOME/.docker
          docker context use desktop-linux
        displayName: 'Set Docker Context with Config'

      - script: |
          docker context ls
        displayName: 'Verify Docker Contexts'

      - script: |
          export DOCKER_HOST=$(docker_host)
          docker ps
        displayName: 'Test Docker Connection'

      # Push Backend Docker Image
      - script: |
          docker push $(containerRegistry)/azurephotoflow-backend:$(Build.BuildId)
        displayName: Push Backend Docker Image

      # Push Frontend Docker Image
      - script: |
          docker push $(containerRegistry)/azurephotoflow-frontend:$(Build.BuildId)
        displayName: Push Frontend Docker Image

  - job: DeployContainers
    displayName: Deploy Containers to Azure and Local Docker
    variables:
      - group: 'PhotoFlow'
    dependsOn: PushDockerImages
    steps:
      # Login to Azure Container Registry
      - task: Docker@2
        displayName: Login to ACR
        inputs:
          command: login
          containerRegistry: $(containerRegistryConnection)

      - script: |
          export DOCKER_CONFIG=$HOME/.docker
          docker context use desktop-linux
        displayName: 'Set Docker Context with Config'

      - script: |
          docker context ls
        displayName: 'Verify Docker Contexts'

      - script: |
          export DOCKER_HOST=$(docker_host)
          docker ps
        displayName: 'Test Docker Connection'

      # Pull Backend Docker Image Locally
      - script: |
          docker pull $(containerRegistry)/azurephotoflow-backend:$(Build.BuildId)
        displayName: Pull Backend Docker Image Locally

      # Pull Frontend Docker Image Locally
      - script: |
          docker pull $(containerRegistry)/azurephotoflow-frontend:$(Build.BuildId)
        displayName: Pull Frontend Docker Image Locally

      # Run Backend Container Locally
      - script: |
          docker stop azurephotoflow-backend || true
          docker rm azurephotoflow-backend || true
          docker run -d --name azurephotoflow-backend -p 8080:8080 $(containerRegistry)/azurephotoflow-backend:$(Build.BuildId)
        displayName: Run Backend Container Locally

      # Run Frontend Container Locally
      - script: |
          docker stop azurephotoflow-frontend || true
          docker rm azurephotoflow-frontend || true
          docker run -d --name azurephotoflow-frontend -p 3000:3000 $(containerRegistry)/azurephotoflow-frontend:$(Build.BuildId)
        displayName: Run Frontend Container Locally

      # Configure Environment Variables for App Services
      - script: |
          echo "Configuring environment variables for App Services..."
          az webapp config appsettings set --name $(backendAppServiceName) --resource-group $(resourceGroupName) --settings AZURE_BLOB_STORAGE=$(AzureBlobStorageConnectionString)
          az webapp config appsettings set --name $(frontendAppServiceName) --resource-group $(resourceGroupName) --settings AZURE_BLOB_STORAGE=$(AzureBlobStorageConnectionString)

          az webapp config appsettings set --name $(backendAppServiceName) --resource-group $(resourceGroupName) --settings VITE_API_BASE_URL=$(Backend_base_url)
          az webapp config appsettings set --name $(frontendAppServiceName) --resource-group $(resourceGroupName) --settings VITE_API_BASE_URL=$(Backend_base_url)

          az webapp config appsettings set --name $(backendAppServiceName) --resource-group $(resourceGroupName) --settings CERTIFICATE_PASSWORD=$(Https_cert_password)
          az webapp config appsettings set --name $(frontendAppServiceName) --resource-group $(resourceGroupName) --settings CERTIFICATE_PASSWORD=$(Https_cert_password)

          az webapp config appsettings set --name $(backendAppServiceName) --resource-group $(resourceGroupName) --settings NODE_ENV=production
          az webapp config appsettings set --name $(frontendAppServiceName) --resource-group $(resourceGroupName) --settings NODE_ENV=production

          az webapp config set --name $(frontendAppServiceName) --resource-group $(resourceGroupName) --linux-fx-version "DOCKER|$(containerRegistry)/azurephotoflow-frontend:latest"
          az resource update --ids "/subscriptions/$(subscriptionId)/resourceGroups/$(resourceGroupName)/providers/Microsoft.Web/sites/$(frontendAppServiceName)" --remove "properties.siteProperties.properties[?(@.name=='WindowsFxVersion')]"
          az webapp log config --name $(frontendAppServiceName) --resource-group $(resourceGroupName) --docker-container-logging filesystem

          az webapp restart --name $(frontendAppServiceName) --resource-group $(resourceGroupName)
          az webapp show --name $(frontendAppServiceName) --resource-group $(resourceGroupName) --query "state"


        displayName: Set Environment Variables for App Services
        env:
          AZURE_BLOB_STORAGE: $(AzureBlobStorageConnectionString)
          VITE_APP_API_BASE_URL: $(Backend_base_url)
          CERTIFICATE_PASSWORD: $(Https_cert_password)

